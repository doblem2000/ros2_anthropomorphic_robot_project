<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>fanuc_m20ia_35m: task_space_trajectory_controller</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">fanuc_m20ia_35m
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">task_space_trajectory_controller </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md89"></a>
Introduction</h1>
<p>The package implements a <code>ros2_control</code> controller for controlling the end-effector of a robot in the task space. It expects both a pose and a velocity reference in the task space, and it computes the corresponding joint velocity through the (pseudo-)inverse Jacobian matrix. The controller can be used both for regulating the end-effector pose and for tracking a trajectory in the task space.</p>
<h1><a class="anchor" id="autotoc_md90"></a>
Prerequisites</h1>
<p>The controller can be configured to control a Joint Model Group of the robot defined in the SRDF file. The following prerequisites must be satisfied in order to use the controller:</p><ul>
<li>The controller expects each joint of the group to have <code>position</code> and <code>velocity</code> state interfaces as well as a <code>velocity</code> command interface (as it controls the joint velocities).</li>
<li>The controller expects to read the URDF description of the robot from the topic specified in the <code>robot_description</code> parameter (default: <code>/robot_description</code>). This means that a <code>robot_state_publisher</code> node must be running and publishing the robot state on the topic specified in the <code>robot_description</code> parameter.</li>
<li>The controller expects to read the SRDF description of the robot from the topic <code>&lt;robot_description&gt;_semantic</code> where <code>&lt;robot_description&gt;</code> is the value of the <code>robot_description</code> parameter. This means that <code>move_group</code> must be running and publishing the SRDF description of the robot on the topic <code>&lt;robot_description&gt;_semantic</code>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md91"></a>
Commanding the controller</h1>
<p>The controller can be used both for regulation and tracking. The controller has two internal states that reflect these features: <code>IDLE</code> and <code>TRACKING_TRAJECTORY</code>. When the controller is activated, it starts in the <code>IDLE</code> state and holds the current pose of the end-effector. When a trajectory is sent to the controller, it switches to the <code>TRACKING_TRAJECTORY</code> state and starts tracking the trajectory. When the trajectory is completed, the controller switches back to the <code>IDLE</code> state and holds the current pose of the end-effector.</p>
<h2><a class="anchor" id="autotoc_md92"></a>
Regulating the end-effector pose</h2>
<p>In order to regulate the end-effector pose on a given point, the user can send a reference <code>moveit_msgs/msg/CartesianTrajectoryPoint</code> on the <code>~/command</code> topic of the controller. Doing this is only recommended for testing purposes as the reference of the controller is instantly changed and this can lead to undesired behaviours when the reference is too far from the current pose of the end-effector. When the controller is in <code>TRACKING_TRAJECTORY</code> state, the references sent on the <code>~/command</code> topic are ignored.</p>
<h2><a class="anchor" id="autotoc_md93"></a>
Tracking a trajectory in the task space</h2>
<p>In order to track a trajectory in the task space, the user can use the action <code>~/FollowCartesianTrajectory</code>. The message type is <code>cartesian_control_msgs/action/FollowCartesianTrajectory</code>. The trajectory is validated before the controller accepts the goal. The trajectory is accepted only if:</p><ul>
<li>the trajectory is not empty;</li>
<li>when the fist point of the trajectory has a timestamp equal to zero, the euclidean distance between the current pose of the end-effector and the first point of the trajectory is less than the <code>first_point_tolerance</code> parameter of the controller;</li>
<li>the timestamp of each point of the trajectory is greater than the timestamp of the previous point;</li>
<li>the header frame of the trajectory is equal to the <code>robot_base_link</code> parameter of the controller;</li>
<li>the controlled frame of the trajectory is equal to the <code>end_effector_link</code> parameter of the controller;</li>
</ul>
<p>If the goal is accepted by the controller, the controller will switch to the <code>TRACKING_TRAJECTORY</code> state and will start tracking the trajectory. When the trajectory is completed, the controller will switch back to the <code>IDLE</code> state and will hold the current pose of the end-effector. It is possible to cancel the goal at any time. If the goal is cancelled, the controller will switch back to the <code>IDLE</code> state and will hold the current pose of the end-effector. However, if a new trajectory is sent to the controller while it is tracking a trajectory, the new trajectory will be rejected.</p>
<h1><a class="anchor" id="autotoc_md94"></a>
Trajectory interpolation</h1>
<p>The controller interpolates the given trajectory in the task space. The interpolation is performed dynamically, i.e. the controller computes the trajectory in the task space at each control cycle.</p>
<p>By default, a linear interpolation is used. For the orientations, SLERP interpolation in the quaternion space is used.</p>
<h1><a class="anchor" id="autotoc_md95"></a>
Controller parameters</h1>
<p>The controller parameters are:</p><ul>
<li><code>joint_model_group_name</code>: the name of the planning group to use;</li>
<li><code>robot_base_link</code>: robot frame workspace velocities are defined in;</li>
<li><code>end_effector_link</code>: the end-effector link of the robot. It must be the last link of the kinematic chain of the planning group;</li>
<li><code>robot_description</code>: the topic where the URDF description of the robot is published;</li>
<li><code>gains</code>: a dictionary containing the gains for the controller. It includes <code>gains.position</code>, <code>gains.orientation</code>, <code>gains.velocity</code> and <code>gains.k0</code> gains.<ul>
<li><code>gains.position</code> includes <code>gains.position.x</code>, <code>gains.position.y</code> and <code>gains.position.z</code> gains for the position control;</li>
<li><code>gains.orientation</code> includes <code>gains.orientation.x</code>, <code>gains.orientation.y</code> and <code>gains.orientation.z</code> gains for the orientation control;</li>
<li><code>gains.velocity</code> includes <code>gains.velocity.linear.x</code>, <code>gains.velocity.linear.y</code>, <code>gains.velocity.linear.z</code> gains for the linear velocity and <code>gains.velocity.angular.x</code>, <code>gains.velocity.angular.y</code> and <code>gains.velocity.angular.z</code> gains for the velocity control;</li>
<li><code>gains.k0</code> is the gain for the movements in the null space control.</li>
</ul>
</li>
<li><code>action_server.first_point_tolerance</code>: the error tolerance for the first point of the trajectory. If the error is greater than this value, the controller will not start the trajectory execution;</li>
<li><code>use_nullspace</code>: boolean value to enable/disable the null space control;</li>
<li><code>debug</code>: boolean value to enable/disable the debug mode. This mode publishes TFs for the reference and the current pose of the end-effector on the <code>/tf</code> topic.</li>
</ul>
<h1><a class="anchor" id="autotoc_md96"></a>
Installing the dependencies</h1>
<p>In order to install the needed dependencies run the command</p>
<div class="fragment"><div class="line">rosdep install --from-paths src --ignore-src -r -y</div>
</div><!-- fragment --><p>inside the project's root folder</p>
<h1><a class="anchor" id="autotoc_md97"></a>
Running the package</h1>
<p>The package has no launch files as those in <code>controller_manager</code> package can be used to spawn the controller (i.e. <code>ros2 launch controller_manager spawner</code>). However, for ease of use, it is recommended to use the launch files provided in the <code>acg_resources_fanuc_m20ia_35m_controllers</code> package. For more info, refer to the README of that package.</p>
<h1><a class="anchor" id="autotoc_md98"></a>
Known issues</h1>
<ul>
<li>A limitation of the chosen control algorithm is that it is not collision-aware as it is intended to be used in free space. This means that the controller can lead to undesired behaviours when the robot is in self-collision or in collision with the environment. In the case of the Fanuc M20-iA/35M robot, this usually happens when the end-effector collides with the link 5 of the robot. To mitigate this issue, one should use the controller in combination with a collision-aware motion planner, such as MoveIt!, but this does not guarantee that the robot will not self-collide during the trajectory execution.</li>
<li>Another problem that is common to all kinematic control algorithms is that the controller could impose high joint velocities to the robot when the robot is close to a singularity. We tried to overcome this problem by using the null space to maximize the manipulability measure of the robot, however in order to keep the controller stable we had to use a very low gain for the null space component. This leds to a very slow convergence of the nullspace component (but it does not affect the tracking of the trajectory in the task space). As a consequence, when using the task space controller <b>one should wait for the robot to stand still</b> before sending a new trajectory to the controller. Doing so minimizes the risk of the robot to be close to a singularity and allows for better tracking performances. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
