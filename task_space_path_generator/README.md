# task_space_path_generator

## Introduction
This package contains:
- the implementation of `ouroboros`, a ROS2 node for generating task space trajectories for robotic manipulators and exporting them to a bagfile;
- `ouroboros_gui`, a GUI for `ouroboros` implemented in Qt5;
- `path_viewer`, a ROS2 node for visualizing the trajectories generated by `ouroboros`.

## Task space path generator
The `ouroboros` node is implemented in python and it is mainly based on `rclpy`, `rosbag2_py` and `tf2_ros` libraries. It was written with extensibility in mind, so it is easy to add new path generation algorithms by implementing the `PathGenerator` abstract class. 

### Node parameters
The node can be configured through the yaml files in the `config` folder. The folder contains three kind of files:
- `<robot_name>.yaml`: contains the ros2 parameters for the robot model `<robot_name>` as well as the needed parameters for the launch files;
- `<robot_name>.rviz`: contains the RViz configuration for the robot model `<robot_name>` without the MoveIt2 plugin;
- `<robot_name>_moveit.rviz`: contains the RViz configuration for the robot model `<robot_name>` with the MoveIt2 plugin.
A new robot can be added by simply adding these three files to the `config` folder.

The node parameters are:
- `draw_base_frame`: the name of the base frame used for drawing the path in RViz. This can be dynamically changed at runtime through the GUI;
- `export_base_frame`: the name of the base frame used for exporting the path to a bagfile. Usually this shouldn't be changed at runtime and can't be changed through the GUI;
- `marker_topic`: the name of the topic used for publishing the path visualization markers. Usually this shouldn't be changed at runtime;
- `path_publish_rate`: the rate at which the path is published on the `marker_topic`;
- `tf_publish_rate`: the rate at which the path frame is published on the `tf` topic;
- `n_samples_draw`: the number of samples used for drawing the path in RViz;
- `n_samples_export`: the number of samples used for exporting the path to a bagfile. Usually it is a good idea to use a higher number of samples for exporting the path to a bagfile, so that the path can be properly interpolated by the planning system.

## Launch files
The recommended way to use `ouroboros` is through the provided launch files which spawn all the nodes needed to generate and visualize a task space trajectory in real time. 

The launch file are robot-agnostic, so they can be used with any robot model as long as the proper configuration files are provided in the `config` folder of the package. We already provide configuration files for the panda robot as well as for the Fanuc M-20iA/35M robot. In order to expand the list of supported robots, please refer to the configuration files in the `config` folder.

After generating a path in a bagfile, it can be visualized in RViz with the `path_viewer` node.

### Task space path generation with joint state publisher
This launch file allows to generate a task space trajectory for a robot and visualize it together with the robot model in RViz. The node `joint_state_publisher` is also spawned, so the user can control the robot joints through the GUI while visualizing the generated path. 

This demo is useful as it allows to properly choose the parameters of the generated path with relation to an arbitrary robot configuration. This is particularly useful as `ouroboros` allows to generate the path wrt the end effector frame. However, the user should be careful to choose a robot configuration that is feasible for the robot, otherwise the generated path may be unfeasible. Also, it is responsibility of the user to choose path parameters that are feasible for the robot, otherwise the generated path may be unfeasible.

To launch the demo, run:
    ```bash
    ros2 launch task_space_path_generator path_generator_rviz.launch.py robot_name:=<robot_name>
    ```
where `<robot_name>` is the name of the robot model to be used. For now, the only supported robot models are `panda` and `fanuc_m20ia_35m`. So, for example, to launch the demo with the fanuc robot, run:
    ```bash
    ros2 launch task_space_path_generator path_generator_rviz.launch.py robot_name:=fanuc_m20ia_35m
    ```

### Task space path generation with MoveIt2 planner
This launch file allows to generate a task space trajectory for a robot and visualize it together with the robot model in RViz. The MoveIt2 planning system is also spawned together with the MoveIt RViz plugin, so the user can plan ad execute trajectories with MoveIt while visualizing the generated path. 

This demo is useful as it allows to properly choose the parameters of the generated path while taking into account the constraints of the robot. For example, the user can plan a trajectory with MoveIt to bring it to a desired configuration and then generate a task space trajectory starting from that configuration. This way, the user can be sure that the starting point of the path path is feasible for the robot. However, it is still responsibility of the user to choose path parameters that are feasible for the robot, otherwise the generated path may be unfeasible.

To launch the demo, run:
    ```bash
    ros2 launch task_space_path_generator path_generator_moveit.launch.py robot_name:=<robot_name>
    ```
where `<robot_name>` is the name of the robot model to be used. For now, the only supported robot model is `fanuc_m20ia_35m`. So, to launch the demo with the fanuc robot, run:
    ```bash
    ros2 launch task_space_path_generator path_generator_moveit.launch.py robot_name:=fanuc_m20ia_35m
    ```

### Visualizing a path from a bagfile
The node `path_viewer` allows to visualize a task space trajectory from a bagfile. The path can be visualized together with the robot model in RViz2.
In order to visualize a path first you need to open RViz with the correct configuration. This can easily done with the provided launch file:
    ```bash
    ros2 launch task_space_path_generator rviz.launch.py robot_name:=<robot_name>
    ```
where `<robot_name>` is the name of the robot model to be used. For now, the only supported robot model is `fanuc_m20ia_35m`. So, to launch the demo with the fanuc robot, run:
    ```bash
    ros2 launch task_space_path_generator path_generator_moveit.launch.py robot_name:=fanuc_m20ia_35m
    ```
Then to visualize the path, run:
    ```bash
    ros2 run task_space_path_generator view_path <path_to_bagfile>
    ```
where `<path_to_bagfile>` is the path to the bagfile containing the path to be visualized. The path will appear in RViz2 as a red line.

## Usage
The GUI allows to dynamically select the type of path to be generated and to change the parameters of the selected path. The supported paths so far are:
- `Sine Wave`: a sine wave path;
- `Sine Wave (one period)`: a sine wave path with only one period.
Each path has dynamic parameters that can be changed at runtime through the GUI.

The planar paths are generated in the XY plane of a frame called `cartesian_path_frame`. The orientation of the exported path is always perpendicular to this plane. 

The GUI also allows to change the base frame used for drawing the path in RViz2. This is internally named `draw frame` and is different from the base frame used for exporting the path to a bagfile, which is internally named `export frame`. Usually the export frame will be the robot base frame, while the draw frame will be the end effector frame. However, the draw frame can be changed at runtime according to the user needs. The user can control the robot joints by means of external methods, and the generated path will move as the chosen `draw frame` moves. 

The planar paths are generated in the XY plane of a frame called `cartesian_path_frame`. This frame is published on the `/tf` topic and can be visualized in RViz2 in real time. The transform from the `draw frame` to the `cartesian_path_frame` can be changed at runtime through the GUI, which allows to specify both the position and the orientation of the `cartesian_path_frame` wrt the `draw frame`. However it is not recommended to change these parameters too much because it could lead to unfeasible paths. Notice that the path will always be exported wrt the `export_base_frame` parameter of the node.

When the user exports the path to a bagfile, the path is saved in the `/cartesian_path` topic and the path is saved as a `geometry_msgs/msg/PoseArray` message. The base frame of the path is the `export_base_frame` parameter of the node. When exporting the path, `ouroboros` dynamically calculates the transform between `draw_base_frame` and `export_base_frame` to get the correct coordinates for the path. The number of samples of the path is determined by the `n_samples_export` parameter of the node. The exported path which can be used for planning a trajectory with our planning module.

The recommended way of generating a path is the following:
- launch either the `path_generator_rviz.launch.py` or the `path_generator_moveit.launch.py` launch file as described above;
- select the type of path to be generated from the GUI;
- change the draw frame as the end effector frame of the robot (or any other frame you want to use);
- move the robot to a feasible configuration which will be the starting point of the path (either with joint_state_publisher or with MoveIt2);
- change the path parameters through the GUI until you are satisfied with the generated path;
- export the path to a bagfile by pressing the `Export path` button.

Example trajectories can be found in the `resource\Example_trajectories` folder, while the `resource\Example_trajectories\Screen` folder has previews to visualize what the trajectory is.